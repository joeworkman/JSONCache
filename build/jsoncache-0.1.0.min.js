/*
 JSONCache version 0.1.0

 Copyright (c) 2011 Kimmo Puputti
 Licenced under the MIT licence.
 See LICENCE file for more information.

 Authors:
 Kimmo Puputti (first.last@futurice.com)
 Jarno Rantanen (first.last@futurice.com)

 See README.rst at https://github.com/kpuputti/JSONCache
 for requirements and usage.
*/
(function(l){var g={version:"0.1.0",debug:!0,numTries:5,waitTime:200,itemLifetime:3E5,maxCacheSize:2621440,autoEvict:!0},f={};f.settings=g;var i=function(){if(g.debug&&window.console){var b=Array.prototype.slice.call(arguments);b.unshift("JSONCache:");console.log.apply(console,b)}};g.browserOk=function(){var b=window.JSON&&typeof window.JSON.parse==="function"&&typeof window.JSON.stringify==="function",a;try{a="localStorage"in window&&window.localStorage!==null}catch(c){a=!1}return b&&a}();var j=
function(b){if(typeof b!=="number")throw Error("Cannot update cache total size without a char count");var a=parseInt(window.localStorage["JSONCache size"],10);isNaN(a)&&(a=0);b=a+b*2;b<=0?delete window.localStorage["JSONCache size"]:window.localStorage["JSONCache size"]=b},m=function(b,a){var c=JSON.stringify(a),d=c.length,e=f._getTime(),h=function(){if(f.getCacheSize()+d*2>g.maxCacheSize)throw Error("Cache add would exceed maxCacheSize ("+(f.getCacheSize()+d*2)+" > "+g.maxCacheSize+")");try{window.localStorage["JSONCache data "+
b]=c,window.localStorage["JSONCache time "+b]=e,j(d)}catch(a){throw Error("Error adding data to localStorage, quota might be full.");}};if(g.autoEvict)for(;;)try{h();break}catch(n){if(f.getCacheSize()===0)throw Error("Cache add would exceed maxCacheSize ("+(f.getCacheSize()+d*2)+" > "+g.maxCacheSize+") even after autoEvicting everything");f.purgeOldest()}else h()};f.getCacheSize=function(){var b=parseInt(window.localStorage["JSONCache size"],10);return isNaN(b)?0:b};var k=function(b){b=parseInt(b,
10);return!isNaN(b)&&b+g.itemLifetime>=f._getTime()};f.clear=function(b){if(b)window.localStorage["JSONCache data "+b]&&j(-1*window.localStorage["JSONCache data "+b].length),window.localStorage.removeItem("JSONCache data "+b),window.localStorage.removeItem("JSONCache time "+b);else{var b=/^JSONCache (data|time) /,a,c,d=window.localStorage.length,e=[];for(a=0;a<d;++a)c=window.localStorage.key(a),b.test(c)&&e.push(c);d=e.length;for(a=0;a<d;++a)window.localStorage.removeItem(e[a]);delete window.localStorage["JSONCache size"]}};
f.clean=function(){var b=/^JSONCache time ([\S]+)$/,a,c,d=[],e,h=window.localStorage.length;for(e=0;e<h;++e)a=window.localStorage.key(e),(c=b.exec(a))&&!k(window.localStorage[a])&&d.push(c[1]);h=d.length;for(e=0;e<h;++e)f.clear(d[e])};f.purgeOldest=function(){for(var b=/^JSONCache time /,a,c=null,d,e,h=window.localStorage.length,g=0;g<h;++g)if(d=window.localStorage.key(g),b.test(d)&&(e=parseInt(window.localStorage[d],10),!isNaN(e)&&(c===null||e<c)))a=d,c=e;c!==null&&f.clear(a.replace("JSONCache time ",
""))};f._getJSONProxy=function(b,a){l.ajax(b,a)};f._getTime=function(){return(new Date).getTime()};f._tryGetJSON=function(b,a,c,d){if(c>g.numTries){if(i("Tried fetching",c-1,"times already, returning."),typeof a.ongiveup==="function")a.ongiveup("timeout")}else{a.error=function(e,g,j){i("Ajax error with status:",g);if(typeof a.onerror==="function")a.onerror(e,g,j,c);window.setTimeout(function(){f._tryGetJSON(b,a,c+1,d*2)},d)};if(typeof a.ontry==="function")a.ontry(c);f._getJSONProxy(b,a)}};f.getCachedJSON=
function(b,a){var a=a||{},c=a.success,d=window.localStorage["JSONCache data "+b],e=window.localStorage["JSONCache time "+b];d&&k(e)?(i("Value found from cache for url:",b),typeof c==="function"&&c(JSON.parse(d))):(i("Value not found in cache fetching data from url:",b),a.success=function(a){i("Fetched data, adding to cache for url:",b);m(b,a);typeof c==="function"&&c(a)},a.dataType="json",f._tryGetJSON(b,a,1,g.waitTime))};window.JSONCache=f})(jQuery);
